name: Build binary

on:
  workflow_dispatch:
    inputs:
      goos:
        description: "Target OS"
        required: true
        default: "linux"
        type: choice
        options:
          - linux
          - windows
          - freebsd
          - netbsd
          - openbsd
          - darwin
      goarch:
        description: "Target architecture"
        required: true
        default: "amd64"
        type: choice
        options:
          - amd64
          - arm
          - arm64
      goarm:
        description: "Target ARM version(only used with arm architecture)"
        required: true
        default: "7"
        type: choice
        options:
          - 6
          - 7

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Input Check
        id: check
        run: |
          if [[ "${{ inputs.goos }}" == "windows" && "${{ inputs.goarch }}" == "arm" ]]; then
            echo "Combination goos=windows goarch=arm is not supported"
            exit 1
          elif [[ "${{ inputs.goos }}" == "windows" && "${{ inputs.goarch }}" == "arm64" ]]; then
            echo "Combination goos=windows goarch=arm64 is not supported"
            exit 1
          fi

      - name: Check out code into the Go module directory
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Golang
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Zig
        uses: goto-bus-stop/setup-zig@v2

      - name: Setup ZigCC & ZigCPP
        run: |
          go install github.com/dosgo/zigtool/zigcc@latest
          go install github.com/dosgo/zigtool/zigcpp@latest

      - name: Download dependencies
        run: go mod download

      - name: Get variables
        id: get_vars
        run: |
          if [[ "${{ github.repository_owner }}" == "0xERR0R" ]]; then
            echo "version=$(git describe --always --tags)" >> $GITHUB_OUTPUT
          else
            git remote add upstream https://github.com/0xERR0R/blocky.git
            git fetch upstream
            echo "version=$(git describe --always --tags upstream/main)" >> $GITHUB_OUTPUT
          fi
          if [[ "${{ inputs.goarch }}" == "arm" ]]; then
            echo "arch=${{ inputs.goarch }}${{ inputs.goarm }}" >> $GITHUB_OUTPUT
          else
            echo "arch=${{ inputs.goarch }}" >> $GITHUB_OUTPUT
          fi

      - name: Build
        env:
          GO_SKIP_GENERATE: 1
          CGO_ENABLED: 0
          CC: zigcc
          CXX: zigcpp
          GOOS: ${{ inputs.goos }}
          GOARCH: ${{ inputs.goarch }}
          GOARM: ${{ inputs.goarm }}
          VERSION: ${{ steps.get_vars.outputs.version }}
        run: |
          if [[ "${{ inputs.goarch }}" != "arm" ]]; then
            unset GOARM
          fi
          make build

      - name: Rename binary
        run: |
          if [[ "${{ inputs.goos }}" == "windows" ]]; then
            mv bin/blocky bin/blocky.exe
          else
            mv bin/blocky bin/blocky-${{ inputs.goos }}-${{ steps.get_vars.outputs.arch }}
          fi

      - name: Store build artifact
        uses: actions/upload-artifact@v4
        with:
          name: blocky-${{ steps.get_vars.outputs.version }}-${{ inputs.goos }}-${{ steps.get_vars.outputs.arch }}
          path: bin/blocky*
          retention-days: 5
